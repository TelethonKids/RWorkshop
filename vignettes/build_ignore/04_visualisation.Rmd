---
title: "Data Visualisation (static)"
author: "Matt Cooper"
date: "`r format(Sys.time(), '%d %B %Y')`"
output:
  ioslides_presentation:
    template: assets/templates/ioslides.html
    logo: assets/images/logo800.jpg
    css: assets/css/ioslides.css
    widescreen: true
    incremental: true
vignette: >
  %\VignetteIndexEntry{Introduction to Data Manipulation}
  %\VignetteEngine{knitr::rmarkdown}
  \usepackage[utf8]{inputenc}
  
---

```{r init, include = FALSE, echo = FALSE}
library(biometrics)
library(lubridate)
library(tidyverse)
library(kableExtra)
library(gridExtra)
library(grid)
source("04_additional/04_visualisation_helper.R")
```

# Worked example

## Worked example {.smaller}

```{r echo = T, eval = F}
dat <- read_csv("/Users/mcooper/Documents/my_proj_git/RWorkshop/data/demo.csv")
dat2 <- read_csv("/Users/mcooper/Documents/my_proj_git/RWorkshop/data/demo_complications.csv")

theme_set(theme_minimal())
theme_update(
  panel.grid.minor = element_blank(),
  panel.border = element_blank(),
  axis.line.x = element_line(),
  axis.line.y = element_line()
)
```

## Worked example {.smaller}

```{r echo = T, eval = F}
dat %>%
  left_join(dat2) %>%
  pivot_longer(cols = day1:day3) %>%
  group_by(id) %>%
  filter(value < 100) %>%
  mutate(max = case_when(value == max(value, na.rm = T) ~ 1,
                         TRUE ~ 0),
         any_comp = case_when(any(!is.na(complications)) ~ "Yes",
                              TRUE ~ "No")) %>%
  ungroup() %>%
  mutate(sex = as.factor(case_when(male == T ~ "Male",
                                   TRUE ~ "Female")),
         name = as.numeric(as.factor(name)),
         any_comp = as.factor(any_comp)) %>%
```  

## Worked example {.smaller}

```{r echo = T, eval = F}
  ggplot(aes(x = name, y = value)) +
  geom_line(aes(colour = any_comp, group = id), alpha = 0.3) +
  geom_point(colour = "Red", alpha = 0.7, size = 3,
             data = . %>% filter(max == 1)) +
  geom_point(aes(colour = any_comp), alpha = 0.7) +
  geom_smooth(aes(colour = any_comp), method = lm, 
              formula = y ~ x, size = 2, se = F) + 
  facet_wrap( ~ sex + intervention) +
  scale_color_manual(values=c("#002D88", "#F3AB00")) +
  scale_x_continuous(breaks = 1:3) +
  labs(colour = "Any Complication",
       x = "Time (days)",
       y = "Value (units)") 
```

20 lines of code, from data to:

## Worked example 

```{r echo = F, out.width = "105%", fig.align='center', warning = F, message = F}
dat %>%
  left_join(dat2) %>%
  pivot_longer(cols = day1:day3) %>%
  group_by(id) %>%
  filter(value < 100) %>%
  mutate(max = case_when(value == max(value, na.rm = T) ~ 1,
                         TRUE ~ 0),
         any_comp = case_when(any(!is.na(complications)) ~ "Yes",
                              TRUE ~ "No")) %>%
  ungroup() %>%
  mutate(sex = as.factor(case_when(male == T ~ "Male",
                                   TRUE ~ "Female")),
         name = as.numeric(as.factor(name)),
         any_comp = as.factor(any_comp)) %>%
  ggplot(aes(x = name, y = value)) +
  geom_line(aes(colour = any_comp, group = id), alpha = 0.3) +
  geom_point(colour = "Red", alpha = 0.7, size = 3,
             data = . %>% filter(max == 1)) +
  geom_point(aes(colour = any_comp), alpha = 0.7) +
  geom_smooth(aes(colour = any_comp), method = lm, 
              formula = y ~ x, size = 2, se = F) + 
  facet_wrap( ~ sex + intervention) +
  scale_color_manual(values=c("#002D88", "#F3AB00")) +
  scale_x_continuous(breaks = 1:3) +
  labs(colour = "Any Complication",
       x = "Time (days)",
       y = "Value (units)") 
```

## Session resources

[https://github.com/TelethonKids/RWorkshop](https://github.com/TelethonKids/RWorkshop)

[Worked example](https://github.com/TelethonKids/RWorkshop/tree/master/R/03_data_manipulation)
[Slides](https://github.com/TelethonKids/RWorkshop/tree/master/inst/doc/reproducable-research.html)

# ggplot2

## What do you want to plot? (and why)

**Plan your figure!**

What are the key elements of the information your are trying to portray?

What is their structure/composition?

Sketch a draft on paper?

## What do you want to plot? (and why)

**Plan your figure!**

- What type of data do you have?

*continuous, discrete, categorical? one point per person, many?*

- Are your data in groups?

*how many levels are within each group? what are the most important grouping variables?*

- What information are you trying to portray?

*group level summary data? data for all individuals? comparison data between groups?*

## What do you want to plot? (and why)

Think about the finishing touches:

- Colour/line-type differentiation?
- A legend?
- Tick mark frequency? Breaks? (5,10,15 etc)
- Labels (verbose, units)
- Scale? (will outliers distort your plans)
- Error bars?
- Text/values/annotations within the figure?

## The ggplot2 package

There are many plotting options (base, lattice, plotly etc)

We will focus on ggplot2, as it is (arguably) the most versatile and best suited to producing customised publication (/presentation) ready figures.

## The ggplot2 package

<code>ggplot2</code> is based on the grammar of graphics, the
idea that you can build every graph from the same
few components: a data set, a set of geomsâ€”visual
marks that represent data points, and a coordinate
system

## The ggplot2 package





Components (terminology) we will cover:

- aesthetics
- geoms
- scales
- themes
- coordinates
- facets
- grids (a little)
- summary (a little)

## The ggplot2 package - support

Main resource: [ggplot2 website](https://ggplot2.tidyverse.org/reference/)

- easy to navigate 
- has lots of visual examples
- best source of accurate (contemporary) information/examples

## The ggplot2 package - support

```{r, echo = F, out.extra = "figure", out.width = "100%", fig.align='center'}
knitr::include_graphics(file.path("04_additional/04_ggplot2_site.png"))
```

## The ggplot2 package - key concept {.smaller}

ggplot2 works in layers (photoshop?):

- from a coding perspective
- from a visual perspective
- from a conceptual perspective

```{r, echo = F, out.extra = "figure", out.width = "55%", fig.align='center'}
knitr::include_graphics(file.path("04_additional/04_layers.png"))
```

## The ggplot2 package - layering {.smaller}

<div class = "col2 small">
```{r, echo = T, out.extra = "figure", out.width = "400px", fig.align='center'}
dat %>% filter(id %in% c(1,3)) %>%
  pivot_longer(cols = day1:day3) %>%
  ggplot(aes(x = name, y = value, group = factor(id))) + theme_minimal(20) + theme(legend.position = "none") +
  geom_point(aes(colour = factor(id)), size = 9) +
  geom_line(size = 3)
```

```{r, echo = T, out.extra = "figure", out.width = "400px", fig.align='center'}
dat %>% filter(id %in% c(1,3)) %>%
  pivot_longer(cols = day1:day3) %>%
  ggplot(aes(x = name, y = value, group = factor(id))) + theme_minimal(20) + theme(legend.position = "none") +
  geom_line(size = 3) +
  geom_point(aes(colour = factor(id)), size = 9) 
```

</div>

## Shape your data

(should this be the first or last section?)

Your data almost always need it to be long format.

You may need to become familiar with <code>pivot_longer</code> from the <code>tidyr</code> package.

**Think! If you want to do something with a variable in your plot, it needs to be a column in your dataset**

## Shape your data


## Basics of using ggplot2

Code will be in three parts, all joined with a <code>+</code> at the end.

<code>
ggplot(...) +     [Part 1 - call to ggplot2]
  geom_1(...) +   [Part 2 - select and customise the objects to appear on the plot ]
  geom_2(...) +
  stat_(...) +
  scale_(...) +   [Part 3 - tweak your plot]
  theme(...)
</code>

## Using ggplot2 | Aesthetics 

Aesthetics are where you link variables in your data to the building blocks of your plot.

<code>aes(x = age, y = height, colour = sex, group = ethnicity) </code>

- Typically, these are defined in Part 1, the <code>ggplot</code> call. 
  + If so, they will cascade through to all other layers.
- You can set these invidiually within each <code>geom_</code> call

## Using ggplot2 | Part 1 - the ggplot command

Not too much to know.

- First argument will be your dataset (works nicely when piping <code>%>%</code>commands together)
- Then you set aesthestics if you wish

<code>ggplot(my_data, aes(x = calendar_year, y = mortality_rate))</code>

## Using ggplot2 | Part 2 - The geoms

This is where you choose what visual marks will represent your data.



## Using ggplot2 | Part 3 - Tweaking your plot, basics

Lets set up a plot to tweak.

```{r echo = T}
p <- dat %>% filter(dob > "2000-01-01") %>% ggplot() +
  theme_grey(base_size = 18)
```

## Using ggplot2 | Part 3 - Tweaking your plot, basics

Tidying up the labels for your axis/title.

```{r echo = T, out.extra = "figure", out.width = "400px", fig.align='center'}
p + geom_point(aes(x = dob, y = day1)) +
  labs(x = "Date of birth", y = expression(HbA[1*c]*"(%)"))
```

## Using ggplot2 | Part 3 - Tweaking your plot, basics

Changing the visible area

```{r echo = T, out.extra = "figure", out.width = "400px", fig.align='center'}
p + geom_point(aes(x = dob, y = day1)) +
  coord_cartesian(ylim = c(4,8), expand = T) # default
```

## Using ggplot2 | Part 3 - Tweaking your plot, basics

Changing the scale of the axis

```{r echo = T, out.extra = "figure", out.width = "400px", fig.align='center'}
p + geom_point(aes(x = dob, y = day1)) +
  scale_x_date(date_breaks = "1 year") # yuck
```

## Using ggplot2 | Part 3 - Tweaking your plot, basics

Changing the scale of the axis

```{r echo = T, out.extra = "figure", out.width = "400px", fig.align='center'}
p + geom_point(aes(x = dob, y = day1)) +
  scale_x_date(date_breaks = "1 year", date_labels = "%Y") # I fixed it
```

## Using ggplot2 | Part 3 - Tweaking your plot {.smaller}

Changing the colour scheme - palettes

```{r echo = T, out.extra = "figure", out.width = "500px", fig.align='center'}
p + geom_point(aes(x = dob, y = day1, colour = intervention)) 
```

## Using ggplot2 | Part 3 - Tweaking your plot

Changing the colour scheme - palettes

```{r echo = T, out.extra = "figure", out.width = "500px", fig.align='center'}
p + geom_point(aes(x = dob, y = day1, colour = intervention)) +
  scale_color_brewer(palette = "Set1") 
```

- Note, fill (inside) vs colour (outside)

## Using ggplot2 | Part 3 - Tweaking your plot

Changing the colour scheme - custom

```{r echo = T, out.extra = "figure", out.width = "400px", fig.align='center'}
p + geom_point(aes(x = dob, y = day1, colour = male)) +
  scale_color_manual(values=c("#002D88", "#F3AB00"))
```

## Using ggplot2 | Part 3 - Tweaking your plot {.smaller}

Note, fill (inside) vs colour (outside)

```{r echo = T, out.extra = "figure", out.width = "500px", fig.align='center'}
p + geom_violin(aes(x = male, y = day1, colour = intervention, fill = intervention)) +
  scale_color_brewer(palette = "Set2") +
  scale_fill_brewer(palette = "Blues") 
```



## Incorporation stats

 

## Incorporation stats | line of best fit








## Themes and tweaks

- grid lines
- colours
- 

## Incorporation stats

- 

## Export options

ggsave() - last figure

pdf() dev.off()


## Common hacks

- two figures side by side

## Aligning the axis  {.smaller}

<code>
gA <- ggplotGrob(a)  
gB <- ggplotGrob(b)  
maxWidth = grid::unit.pmax(gA\$widths[2:5], gB\$widths[2:5])  
gA\$widths[2:5] <- as.list(maxWidth)  
gB\$widths[2:5] <- as.list(maxWidth)  
p <- grid.arrange(gA, gB, ncol=1)
</code> 

## Aligning the axis - bad example

```{r, echo = F, out.extra = "figure", out.width = "60%", fig.align='center'}
knitr::include_graphics(file.path("04_additional/04_align_un_fig.png"))
```

## Aligning the axis - good example

```{r, echo = F, out.extra = "figure", out.width = "60%", fig.align='center'}
knitr::include_graphics(file.path("04_additional/04_align_fig.png"))
```

## Shared legends {.smaller}

```{r eval = F}
grid_arrange_shared_legend <- function(..., ncol = length(list(...)), nrow = 1, position = c("bottom", "right")) {  
  plots <- list(...)  
  position <- match.arg(position)  
  g <- ggplotGrob(plots[[1]] + theme(legend.position = position))$grobs  
...  
...  
  grid.newpage()  
  grid.draw(combined)  
  # return gtable invisibly  
  invisible(combined)  
}
```

## Shared legends - example {.smaller}

```{r echo = T, fig.height = 4, fig.width = 9, warning  = F, message = F}
grid_arrange_shared_legend(p_sl_1, p_sl_2, ncol = 2)
```



## Finding help

- stackoverflow (beware, out of date advice)
















